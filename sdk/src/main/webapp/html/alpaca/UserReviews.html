<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <title>Gitana SDK - In-Context Editing</title>
    <link type="text/css" href="../../alpaca/css/alpaca-${alpaca.version}.css" rel="stylesheet"/>
    <link type="text/css" href="../../css/gitana-sdk-${project.version}.css" rel="stylesheet"/>
    <link type="text/css"
          href="http://ajax.googleapis.com/ajax/libs/jqueryui/${jquery.ui.version}/themes/base/jquery.ui.all.css"
          rel="stylesheet">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/${jquery.version}/jquery.min.js">
    </script>
    <script type="text/javascript"
            src="http://ajax.googleapis.com/ajax/libs/jqueryui/${jquery.ui.version}/jquery-ui.min.js">
    </script>
    <script type="text/javascript" src="../../alpaca/js/alpaca-${alpaca.version}.js">
    </script>
    <script type="text/javascript" src="../../js/gitana.js">
    </script>
    <script type="text/javascript" src="../../js/gitana-sdk-${project.version}.js">
    </script>
    <script type="text/javascript" src="../../js/gitana-sdk-alpaca-${project.version}.js">
    </script>
</head>
<body>
<div class='gitana-example-container'>
    <div class='gitana-example-header' id='user-reviews'>
        <h2>User Reviews</h2>
    </div>
    <div class='gitana-example-body'>
        <div class='gitana-example-case'>
            <h3>User Reviews</h3>
            <h4>User Reviews.</h4>

            <div id="field1">
                <div id="promotion">
                </div>
                <div class="user-reviews-summary">
                    <div id="review_metrics" class="user-reviews-metrics">
                    </div>
                    <div id="review_button" class="user-reviews-button">
                    </div>
                </div>
                <div id="user_reviews">
                </div>
            </div>
            <script type="text/javascript" id="field1-script">
                $(function() {
                    $(document).ready(function() {
                        var promotionNodeId = "theoffice:binderpromotion";
                        var promotionNode;
                        var reviewMatricsNode = null;
                        var el = $('#promotion');
                        var connector = Gitana.SDK.defaults.gitanaConnector;

                        // Render reviews
                        var renderReviews = function (nodeId) {
                            promotionNode.reload().traverse({
                                "associations": {
                                    "theoffice:hasReview": "OUTGOING"
                                },
                                "depth": 1
                            }).then(function(){
                                var _this = this;
                                this.nodes().then(function() {
                                    $('#user_reviews').empty().alpaca({
                                      "view" : {
                                         "globalTemplate": '../../templates/UserReviews.html'
                                        },
                                        "data": this.object,
                                        "postRender": function (renderedReviews) {
                                            $('span.stars').stars();
                                            _this.associations().each( function() {
                                            var associationNode = this;
                                            var association = this.object;
                                            var reviewIndicator = $('<div id="' + association.target + '-indicator"></div>');
                                            reviewIndicator.prependTo($('#' + association.target+' .user-review-indicators'));
                                            reviewIndicator.alpaca({
                                                "view" : {
                                                    "globalTemplate": '../../templates/UserReviewIndicators.html'
                                                },
                                                "data": association,
                                                "postRender" : function(renderedReviewIndicatorsField) {
                                                    var renderedReviewIndicators = renderedReviewIndicatorsField.data;
                                                    var helpfulButton = $('.helpfulbutton', renderedReviewIndicatorsField.container);
                                                    helpfulButton.click(function() {
                                                        if (Alpaca.isEmpty(association.helpfulCounter)) {
                                                            association.helpfulCounter = 1;
                                                            association.totalCounter = 1;
                                                        } else {
                                                            association.helpfulCounter++;
                                                            association.totalCounter++;
                                                        }
                                                        associationNode.chain().update().reload().then(function() {
                                                            $('.helpfulindicator', renderedReviewIndicatorsField.container).html(this.get('helpfulCounter') + ' out of ' + this.get('totalCounter') + ' people found this review helpful.');
                                                            associationNode = this;
                                                            association = this.object;
                                                        });
                                                    });
                                                    var unhelpfulButton = $('.unhelpfulbutton', renderedReviewIndicatorsField.container);
                                                    unhelpfulButton.click(function() {
                                                        if (Alpaca.isEmpty(association.helpfulCounter)) {
                                                            association.helpfulCounter = 1;
                                                            association.totalCounter = 1;
                                                        } else {
                                                            association.totalCounter++;
                                                        }
                                                        associationNode.chain().update().reload().then(function() {
                                                            $('.helpfulindicator', renderedReviewIndicatorsField.container).html(this.get('helpfulCounter') + ' out of ' + this.get('totalCounter') + ' people found this review helpful.');
                                                            associationNode = this;
                                                            association = this.object;
                                                        });
                                                    });
                                                    var spamIndicatorButton = $('.spambutton', renderedReviewIndicatorsField.container);
                                                    spamIndicatorButton.click(function() {
                                                        if (Alpaca.isEmpty(association.spamCounter)) {
                                                            association.spamCounter = 1;
                                                        } else {
                                                            association.spamCounter++;
                                                        }
                                                        associationNode.chain().update().reload().then(function(stats) {
                                                            $('.spamindicator', renderedReviewIndicatorsField.container).html(this.get('spamCounter') + ' people marked this review as inappropriate.');
                                                            associationNode = this;
                                                            association = this.object;
                                                        });
                                                    });
                                                }
                                            });
                                        });
                                    }
                                });
                                });
                            });
                        };

                        var renderReviewMetrics = function (data) {
                            $('#review_metrics').empty().alpaca({
                                "view" : {
                                    "globalTemplate": '../../templates/UserReviewMetrics.html'
                                },
                                "data": data,
                                "postRender": function(renderedField) {
                                    $('span.stars').stars();
                                }
                            });
                        };

                        var displayReviewMetrics = function () {
                            if (reviewMatricsNode != null) {
                                renderReviewMetrics (reviewMatricsNode.object);
                            } else {
                               promotionNode.traverse({
                                    "associations": {
                                       "theoffice:hasReviewMetrics": "BOTH"
                                   },
                                    "depth": 1
                                }).nodes().count( function(count) {
                                    if (count == 0) {
                                        connector.branch.chain().createNode({
                                            "_type" : "theoffice:reviewmetrics",
                                            "totalReviews" : 0,
                                            "averageRating" : 0
                                        }).associate(promotionNodeId, {
                                            "_type" : "theoffice:hasReviewMetrics",
                                            "direction" : "BOTH"
                                        }).then(function() {
                                            renderReviewMetrics(this.object);
                                            reviewMatricsNode = this;
                                        });
                                    }
                                }).keep(1).each(function() {
                                    renderReviewMetrics(this.object);
                                    reviewMatricsNode = this;
                                });
                            }
                        };

                        var updateReviewMetrics = function (reviewVal) {
                            var totalReviews = reviewMatricsNode.get('totalReviews');
                            var averageRating = reviewMatricsNode.get('averageRating');
                            reviewMatricsNode.object.averageRating = (averageRating * totalReviews + reviewVal.rating) / (totalReviews + 1);
                            reviewMatricsNode.object.totalReviews ++;
                            reviewMatricsNode.chain().update().reload().then(function() {
                                renderReviewMetrics(this.object);
                            });
                        };

                            el.alpaca({
                                "view" : {
                                    "globalTemplate": '../../templates/LatestPromotion.html'
                                },
                                "data": promotionNodeId,
                                "connector" : connector,
                                "postRender": function (renderedField) {
                                    promotionNode = connector.getGitanaNode(renderedField.data);
                                    var gitanaDriver = connector.gitanaDriver;

                                    renderReviews();

                                    displayReviewMetrics();

                                    var editButton = $("<button>Write a review</button>").button(({
                                        icons: {
                                            primary: "ui-icon-pencil"
                                        }
                                    }));
                                    editButton.click(function() {
                                        editButton.removeClass("ui-state-focus ui-state-hover");
                                        var editDialog = $('<div id="alpaca-edit-form" title="Write a review"></div>');
                                        var _this = this;
                                            editDialog.alpaca({
                                                "options": "five_star",
                                                "schema": "theoffice:review",
                                                "view":{
                                                    "parent" : "VIEW::WEB_EDIT_LIST",
                                                    "type": "create",
                                                    "styles": {
                                                        ".alpaca-controlfield-label": {
                                                        "width": "200px"
                                                        }
                                                    }
                                                },
                                                "connector": connector,
                                                "postRender": function(renderedNewFieldControl) {
                                                    var saveButton = renderedNewFieldControl.form.saveButton;
                                                    saveButton.hide();
                                                    editDialog.dialog({
                                                        resizable: true,
                                                        height: 550,
                                                        width: 650,
                                                        modal: true,
                                                        buttons: {
                                                            "Create": function() {
                                                                // Do the actual work
                                                                var reviewVal = renderedNewFieldControl.getValue();
                                                                reviewVal._type = "theoffice:review";
                                                                connector.branch.chain().createNode(reviewVal).then(function(){
                                                                    promotionNode.chain().associate(this.getId(), {
                                                                        "_type" : "theoffice:hasReview",
                                                                        "direction" : "OUTGOING"
                                                                    }).then(function(status) {
                                                                        // refresh the indicators
                                                                        updateReviewMetrics(reviewVal);
                                                                        // refresh the review list
                                                                        renderReviews();
                                                                        editDialog.dialog('close');
                                                                    });
                                                                });
                                                            }
                                                        }
                                                    });
                                                    $('.ui-dialog').css("overflow", "hidden");
                                                    $('.ui-dialog-buttonpane').css("overflow", "hidden");
                                                }
                                            });
                                    });
                                    $('#review_button').append(editButton);
                                }
                            });

                    });
                });
            </script>
        </div>
    </div>
    <div class="clear"></div>
    <div class="gitana-example-footer">
        <center class="copyright">
            Copyright &copy; 2011 Gitana Software | All Rights Reserved
        </center>
    </div>
</div>
</body>
</html>
